<!DOCTYPE html>
<html>
<head>
  <title>Login</title>
</head>
<body>
  <h1>Passkey Demo</h1>
  <div id="header" style="transition: opacity 0.3s ease;">
    <label for="username">Username:</label>
    <input type="text" id="username" name="username" title="Please enter your username" />
    <button onclick="startLogin()">Login</button>
  </div>
  <div id="content" style="display:none; margin-top: 20px;">
    <form onsubmit="handleForm(event)">
      <label for="height">Height:</label>
      <input type="number" id="height" name="height" required>
      <label for="width">Width:</label>
      <input type="number" id="width" name="width" required>
      <button type="submit">Submit</button>
    </form>
  </div>

  <script>
    function base64urlToBuffer(b64url) {
      const pad = '='.repeat((4 - b64url.length % 4) % 4);
      const b64 = b64url.replace(/-/g, '+').replace(/_/g, '/') + pad;
      const binary = atob(b64);
      return Uint8Array.from(binary, c => c.charCodeAt(0));
    }

    function bufferToBase64URL(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    async function startLogin() {
      const user = document.getElementById("username").value;
      if (!user) {
        const input = document.getElementById("username");
        input.focus();
        input.reportValidity();
        return;
      }

      const startRes = await fetch(`/login/start?user=${user}`);
      if (!startRes.ok) {
        const resultEl = document.getElementById("content");
        resultEl.innerHTML = `<p>User not recognized.</p>`;
        resultEl.style.display = "block";
        console.log("Showing content div for unrecognized user");
        return;
     
      }
      const wrapper = await startRes.json();
      const publicKey = wrapper.publicKey.publicKey;

      console.log("Login publicKey options:", publicKey);

      publicKey.challenge = base64urlToBuffer(publicKey.challenge);
      publicKey.allowCredentials = publicKey.allowCredentials.map(cred => ({
        ...cred,
        id: base64urlToBuffer(cred.id),
      }));

      const assertion = await navigator.credentials.get({ publicKey });

      const credential = {
        id: assertion.id,
        rawId: bufferToBase64URL(assertion.rawId),
        type: assertion.type,
        response: {
          authenticatorData: bufferToBase64URL(assertion.response.authenticatorData),
          clientDataJSON: bufferToBase64URL(assertion.response.clientDataJSON),
          signature: bufferToBase64URL(assertion.response.signature),
          userHandle: assertion.response.userHandle ? bufferToBase64URL(assertion.response.userHandle) : null
        }
      };

      const finishRes = await fetch(`/login/finish?user=${user}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(credential)
      });

      const resultText = await finishRes.text();
      try {
        const result = JSON.parse(resultText);
        console.log("Login result:", result.message);
        if ((result.message || '').toLowerCase().includes("successful")) {
          const headerEl = document.getElementById("header");
          headerEl.innerHTML = `<h2>Welcome ${user}</h2>`;
          document.getElementById("content").style.display = "block";
          console.log("Replaced header content with welcome message.");
        }
        
      } catch {
        const resultEl = document.getElementById("content");
        
        resultEl.style.display = "block";
      }
    }
  function handleForm(event) {
      event.preventDefault();
      const height = document.getElementById("height").value;
      const width = document.getElementById("width").value;
      alert(`Submitted dimensions: Height = ${height}, Width = ${width}`);
    }
  </script>
</body>
</html>
